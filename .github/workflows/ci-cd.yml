name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'src/RestaurantManagement.API/RestaurantManagement.API.csproj'
  
jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
      
    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"
      
    - name: Check for security vulnerabilities
      run: dotnet list package --vulnerable --include-transitive
      continue-on-error: true
      
    - name: Publish application
      run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output ./publish --no-build
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: restaurant-api
        path: ./publish
        retention-days: 7

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool
      
    - name: Check code formatting
      run: dotnet format --verify-no-changes --verbosity diagnostic
      continue-on-error: true

  # Uncomment and configure based on your chosen platform
  
  # ═══════════════════════════════════════════════════════════
  # OPTION 1: Deploy to Railway.app (RECOMMENDED)
  # ═══════════════════════════════════════════════════════════
  # deploy-railway:
  #   name: Deploy to Railway
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   
  #   - name: Install Railway CLI
  #     run: npm install -g @railway/cli
  #   
  #   - name: Deploy to Railway
  #     run: railway up
  #     env:
  #       RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ═══════════════════════════════════════════════════════════
  # OPTION 2: Deploy to Render.com
  # ═══════════════════════════════════════════════════════════
  # deploy-render:
  #   name: Deploy to Render
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Trigger Render Deploy
  #     run: |
  #       curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}

  # ═══════════════════════════════════════════════════════════
  # OPTION 3: Deploy to Fly.io
  # ═══════════════════════════════════════════════════════════
  # deploy-fly:
  #   name: Deploy to Fly.io
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   
  #   - name: Setup Fly CLI
  #     uses: superfly/flyctl-actions/setup-flyctl@master
  #   
  #   - name: Deploy to Fly.io
  #     run: flyctl deploy --remote-only
  #     env:
  #       FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # ═══════════════════════════════════════════════════════════
  # OPTION 4: Deploy to DigitalOcean App Platform
  # ═══════════════════════════════════════════════════════════
  # deploy-digitalocean:
  #   name: Deploy to DigitalOcean
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   
  #   - name: Install doctl
  #     uses: digitalocean/action-doctl@v2
  #     with:
  #       token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
  #   
  #   - name: Trigger deployment
  #     run: doctl apps create-deployment ${{ secrets.APP_ID }}

  # ═══════════════════════════════════════════════════════════
  # OPTION 5: Deploy via Docker (Generic)
  # ═══════════════════════════════════════════════════════════
  # docker-build-push:
  #   name: Build and Push Docker Image
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   
  #   - name: Set up Docker Buildx
  #     uses: docker/setup-buildx-action@v3
  #   
  #   - name: Login to Docker Hub
  #     uses: docker/login-action@v3
  #     with:
  #       username: ${{ secrets.DOCKER_USERNAME }}
  #       password: ${{ secrets.DOCKER_PASSWORD }}
  #   
  #   - name: Build and push
  #     uses: docker/build-push-action@v5
  #     with:
  #       context: .
  #       push: true
  #       tags: ${{ secrets.DOCKER_USERNAME }}/restaurant-api:latest
  #       file: ./src/RestaurantManagement.API/Dockerfile

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]
    if: always()
    
    steps:
    - name: Send notification
      run: |
        echo "Build Status: ${{ needs.build-and-test.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        # Add your notification logic here (Slack, Discord, Email, etc.)
